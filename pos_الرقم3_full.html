<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± - Ù…ÙˆØ¯Ø±Ù†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <style>
    :root{--accent:#0069ff;--muted:#6c757d}
    body{background:linear-gradient(180deg,#f8fbff 0%, #f3f6fb 100%);font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    .category-btn{cursor:pointer;min-width:88px}
    .product-card{cursor:pointer;transition:transform .14s ease, box-shadow .14s ease}
    .product-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(2,6,23,.08)}
    .bill-box{background:#fff;border-radius:12px;padding:16px;height:100%}
    .order-item{border-bottom:1px dashed #eee;padding:8px 0}
    .category-active{background:var(--accent)!important;color:#fff!important}
    #loginPage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:1050}
    #mainPOS{display:none}
    .small-muted{color:var(--muted);font-size:.9rem}
    .product-price{font-weight:600}
    .category-scroll{overflow-x:auto;padding-bottom:6px}
  </style>
</head>
<body>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginPage">
  <div class="card shadow p-4" style="width:380px;border-radius:14px;">
    <h4 class="text-center mb-3">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h4>
    <input id="user" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="pass" class="form-control mb-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password">
    <button id="loginBtn" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
    <div class="text-center small-muted mt-2">Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ: <strong>admin</strong> / ÙƒÙ„Ù…Ø©: <strong>1234</strong></div>
  </div>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± -->
<div id="mainPOS">
  <div class="container-fluid p-3">
    <div class="row g-3">

      <!-- Ø§Ù„ÙØ§ØªÙˆØ±Ø© + Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… -->
      <div class="col-12 col-lg-4">
        <div class="bill-box shadow-sm">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">ğŸ§¾ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h5>
            <div>
              <button id="todayLogBtn" class="btn btn-sm btn-outline-secondary me-1">Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</button>
              <button id="syncBtn" class="btn btn-sm btn-outline-primary">Ù…Ø²Ø§Ù…Ù†Ø©</button>
            </div>
          </div>

          <div id="orderList" style="min-height:220px"></div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <div>
              <div class="small-muted">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
              <div class="h5" id="total">0.000 Ø±.Ø¹</div>
            </div>
            <div class="text-end">
              <button id="finishBtn" class="btn btn-success mb-2 w-100">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
              <button id="printBtn" class="btn btn-outline-dark w-100">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ø¨Ø­Ø«ØŒ Ø§Ù„ÙØ¦Ø§ØªØŒ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
      <div class="col-12 col-lg-8">
        <div class="mb-2 d-flex gap-2">
          <input id="search" class="form-control flex-grow-1" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ (Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯)" />
          <input id="barcodeInput" class="form-control" placeholder="Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="max-width:200px" />
        </div>

        <div class="category-scroll mb-3" id="categoryContainer"></div>

        <div class="row g-3" id="productsContainer"></div>
      </div>

    </div>
  </div>
</div>

<!-- Modal Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¬Ù… (Ù…ÙˆØ¯Ø§Ù„ Ù…ÙˆØ¯Ø±Ù†) -->
<div class="modal fade" id="sizeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sizeModalLabel">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¬Ù…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="sizeOptions" class="d-flex flex-wrap gap-2 mb-2"></div>
        <div class="mb-2">
          <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="sizeQty" type="number" min="1" value="1" class="form-control" />
        </div>
        <div class="small-muted">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span id="sizeFinalPrice">0.000</span> Ø±.Ø¹</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="sizeAddBtn" type="button" class="btn btn-primary">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… -->
<div class="modal fade" id="logModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><div id="todayLogList"></div></div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* --- Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ© */
const categories = ["ÙØ±ÙŠØ´","ÙƒÙˆÙƒØªÙŠÙ„Ø§Øª","Ø§ÙŠØ³ ÙƒØ±ÙŠÙ…","Ø§Ø·Ø¨Ø§Ù‚","Ù…Ø´Ø±ÙˆØ¨Ø§Øª","Ø³ÙˆÙŠØª"];
const products = [
  {id:1, name:"Ù…Ø§Ù†Ø¬Ùˆ", base:1.0, cat:"ÙØ±ÙŠØ´"},
  {id:2, name:"Ø¬ÙˆØ§ÙØ©", base:1.0, cat:"ÙØ±ÙŠØ´"},
  {id:3, name:"ÙØ±Ø§ÙˆÙ„Ø©", base:1.2, cat:"ÙƒÙˆÙƒØªÙŠÙ„Ø§Øª"},
  {id:4, name:"Ù…ÙˆØ² Ø¨Ø§Ù„Ù„Ø¨Ù†", base:1.3, cat:"ÙƒÙˆÙƒØªÙŠÙ„Ø§Øª"},
  {id:5, name:"ÙØ§Ù†ÙŠÙ„Ø§", base:0.7, cat:"Ø§ÙŠØ³ ÙƒØ±ÙŠÙ…"},
  {id:6, name:"Ø´ÙŠÙƒÙˆÙ„Ø§ØªØ©", base:0.7, cat:"Ø§ÙŠØ³ ÙƒØ±ÙŠÙ…"},
  {id:7, name:"Ø³Ù„Ø§Ø·Ø© ÙÙˆØ§ÙƒÙ‡", base:2.5, cat:"Ø§Ø·Ø¨Ø§Ù‚"},
  {id:8, name:"Ø¨ÙŠØ¨Ø³ÙŠ", base:0.5, cat:"Ù…Ø´Ø±ÙˆØ¨Ø§Øª"},
  {id:9, name:"Ø¨Ø±Ø§ÙˆÙ†ÙŠØ²", base:1.8, cat:"Ø³ÙˆÙŠØª"}
];

const sizes = {"ØµØºÙŠØ±":1, "ÙˆØ³Ø·":1.3, "ÙƒØ¨ÙŠØ±":1.6, "Ù„ØªØ±":2, "Ù„ØªØ± ÙˆÙ†Øµ":2.5};
let currentCategory = categories[0];
let order = [];
let selectedProduct = null;
let selectedSize = null;

/* --- Ø±ÙŠÙ†Ø¯Ø± Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª */
function renderCategories(){
  const box = document.getElementById('categoryContainer'); box.innerHTML='';
  categories.forEach(cat =>{
    const btn = document.createElement('button');
    btn.className='btn btn-sm btn-outline-secondary me-1 mb-1';
    if(cat===currentCategory) btn.className='btn btn-sm category-active me-1 mb-1';
    btn.textContent = cat;
    btn.addEventListener('click', ()=>{ currentCategory=cat; renderCategories(); renderProducts(); });
    box.appendChild(btn);
  });
}

function renderProducts(){
  const box = document.getElementById('productsContainer'); box.innerHTML='';
  const q = (document.getElementById('search').value||'').trim().toLowerCase();
  const filtered = products.filter(p => p.cat === currentCategory && p.name.toLowerCase().includes(q));
  filtered.forEach(p =>{
    const div = document.createElement('div'); div.className='col-6 col-md-4';
    div.innerHTML = `
      <div class="product-card p-3 text-center bg-white rounded shadow-sm" data-id="${p.id}">
        <div class="mb-2"><strong>${p.name}</strong></div>
        <div class="product-price small-muted">Ù…Ù† ${p.base.toFixed(3)} Ø±.Ø¹</div>
      </div>`;
    box.appendChild(div);
  });
  box.querySelectorAll('.product-card').forEach(el=>el.addEventListener('click', ()=>{ chooseSize(Number(el.getAttribute('data-id'))) }));
}

/* --- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¬Ù… */
const sizeModalEl = document.getElementById('sizeModal');
const sizeModal = new bootstrap.Modal(sizeModalEl);
function chooseSize(id){
  selectedProduct = products.find(p=>p.id===id);
  selectedSize = null;
  document.getElementById('sizeOptions').innerHTML='';
  Object.keys(sizes).forEach(s=>{
    const b = document.createElement('button');
    b.className='btn btn-outline-primary btn-sm';
    b.textContent = s;
    b.addEventListener('click', ()=>{
      selectedSize = s;
      document.querySelectorAll('#sizeOptions .btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      updateFinalPrice();
    });
    document.getElementById('sizeOptions').appendChild(b);
  });
  document.getElementById('sizeQty').value = 1;
  updateFinalPrice();
  sizeModal.show();
}

function updateFinalPrice(){
  if(!selectedProduct) return document.getElementById('sizeFinalPrice').textContent = '0.000';
  const sizeFactor = selectedSize ? sizes[selectedSize] : 1;
  const qty = Number(document.getElementById('sizeQty').value || 1);
  const price = (selectedProduct.base * sizeFactor * qty);
  document.getElementById('sizeFinalPrice').textContent = price.toFixed(3);
}

document.getElementById('sizeQty').addEventListener('input', updateFinalPrice);

document.getElementById('sizeAddBtn').addEventListener('click', ()=>{
  if(!selectedProduct) return;
  if(!selectedSize) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ù…');
  const qty = Number(document.getElementById('sizeQty').value || 1);
  const finalPrice = selectedProduct.base * sizes[selectedSize] * qty;
  order.push({ id:selectedProduct.id, name: selectedProduct.name, size: selectedSize, qty, price: finalPrice });
  sizeModal.hide();
  renderOrder();
});

/* --- Ø±ÙŠÙ†Ø¯Ø± Ø§Ù„Ø·Ù„Ø¨ */
function renderOrder(){
  const box = document.getElementById('orderList'); box.innerHTML='';
  let total=0;
  order.forEach((it, idx)=>{
    total += it.price;
    const row = document.createElement('div'); row.className='order-item d-flex justify-content-between align-items-center';
    row.innerHTML = `
      <div>
        <div><strong>${it.name}</strong> <small class="text-muted">(${it.size})</small></div>
        <div class="small-muted">${it.qty} Ã— ${ (it.price/it.qty).toFixed(3) } Ø±.Ø¹</div>
      </div>
      <div class="text-end">
        <div><strong>${it.price.toFixed(3)} Ø±.Ø¹</strong></div>
        <div class="mt-1"><button class="btn btn-sm btn-outline-danger" data-idx="${idx}">Ø­Ø°Ù</button></div>
      </div>`;
    box.appendChild(row);
  });
  box.querySelectorAll('button[data-idx]').forEach(b=>b.addEventListener('click', ()=>{ const i=Number(b.getAttribute('data-idx')); order.splice(i,1); renderOrder(); }));
  document.getElementById('total').textContent = total.toFixed(3) + ' Ø±.Ø¹';
}

/* --- Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (localStorage) */
function saveOrderToLocal(orderObj){
  const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const key = 'pos_orders_' + today;
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push(orderObj);
  localStorage.setItem(key, JSON.stringify(arr));
}

function getTodayOrders(){
  const today = new Date().toISOString().slice(0,10);
  const key = 'pos_orders_' + today;
  return JSON.parse(localStorage.getItem(key) || '[]');
}

/* --- Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… */
const logModal = new bootstrap.Modal(document.getElementById('logModal'));
document.getElementById('todayLogBtn').addEventListener('click', ()=>{
  const list = getTodayOrders();
  const container = document.getElementById('todayLogList'); container.innerHTML='';
  if(list.length===0) container.innerHTML = '<div class="text-center small-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>';
  list.forEach((o, i)=>{
    const el = document.createElement('div'); el.className='mb-2 p-2 bg-white rounded shadow-sm';
    el.innerHTML = `<div class="d-flex justify-content-between"><div><strong>Ø·Ù„Ø¨ ${i+1}</strong><div class='small-muted'>${o.time}</div></div><div><strong>${o.total.toFixed(3)} Ø±.Ø¹</strong></div></div>`;
    // ØªÙØ§ØµÙŠÙ„
    const details = document.createElement('div'); details.className='mt-2 small-muted';
    o.items.forEach(it=> details.innerHTML += `<div>${it.name} (${it.size}) Ã—${it.qty} â€” ${it.price.toFixed(3)} Ø±.Ø¹</div>`);
    el.appendChild(details);
    container.appendChild(el);
  });
  logModal.show();
});

/* --- Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© */
async function finishOrder(){
  if(order.length===0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨');
  const total = order.reduce((s,i)=>s + i.price, 0);
  const obj = { time: new Date().toLocaleString(), total, items: order };
  // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
  saveOrderToLocal(obj);
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… (Ø¥Ù† ÙˆÙØ¬Ø¯)
  try{
    const res = await syncOrder(obj);
    if(res && res.offline){
      // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ù… ØªØªÙ…Ø› Ù†Ø®Ø¨Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø£Ù†Ù‡Ø§ Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
      order = []; renderOrder();
      alert('âœ” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© â€” Ø§Ù„Ø¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†)');
    } else {
      order = []; renderOrder();
      alert('âœ” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
    }
  }catch(err){
    // Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹
    order = []; renderOrder();
    alert('âœ” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)');
    console.error(err);
  }
}

/* --- Ø·Ø¨Ø§Ø¹Ø© */
function printBill(){
  const w = window.open('', '_blank');
  if(!w){ alert('Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø±ÙÙˆØ¶Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Ù…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©).'); return; }
  let html = "<!doctype html><html lang='ar' dir='rtl'><head><meta charset='utf-8'><title>ÙØ§ØªÙˆØ±Ø©</title><style>body{font-family:Arial, sans-serif;direction:rtl;padding:20px}</style></head><body>";
  html += `<h3>ÙØ§ØªÙˆØ±Ø©</h3><div>`;
  order.forEach(i=> html += `<div>${i.name} (${i.size}) Ã—${i.qty} - ${i.price.toFixed(3)} Ø±.Ø¹</div>`);
  const total = order.reduce((s,i)=>s+i.price,0);
  html += `</div><hr><h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(3)} Ø±.Ø¹</h4>`;
  html += `</body></html>`;
  w.document.write(html); w.document.close(); w.focus(); setTimeout(()=>{ w.print(); w.close(); }, 300);
}

/* --- Ø¯ÙˆØ§Ù„ Ù…Ø²Ø§Ù…Ù†Ø© (Ù…ÙØ­Ø³Ù‘Ù†Ø© Ù„Ù„Ø¨ÙŠØ¦Ø§Øª Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù…)
   syncOrder ÙŠØ­Ø§ÙˆÙ„ Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù‰ '/api/orders'.
   - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ù…ØªÙˆÙØ±Ù‹Ø§ ÙˆÙŠØ¹ÙŠØ¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø© 2xxØŒ Ù†ÙØ±Ø¬Ø¹ Ø§Ù„Ù†Ø§ØªØ¬.
   - Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø®Ø§Ø¯Ù… Ù…ØªÙˆÙØ±Ù‹Ø§ (network error Ø£Ùˆ non-2xx) Ù†ÙØ±Ø¬Ø¹ ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ { offline: true }
   Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø±ÙØ¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ØºÙŠØ± Ù…Ø±ØºÙˆØ¨Ø© ÙÙŠ Ø¨ÙŠØ¦Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£Ùˆ sandbox.
*/
async function syncOrder(orderObj){
  // Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø£ÙˆÙ„Ø§Ù‹
  try{
    const res = await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(orderObj) });
    if(res.ok){
      try{ return await res.json(); }catch(e){ return { ok:true }; }
    }
    // Ø®Ø§Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ†Ù‡ Ø£Ø¹Ø§Ø¯ Ø­Ø§Ù„Ø© Ø®Ø·Ø£
    console.warn('Server returned non-OK status', res.status);
    return { offline:true };
  }catch(err){
    // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© -> Ù†Ø¹Ù…Ù„ Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø§Ø¬Ø­Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
    console.warn('syncOrder network error or endpoint not available, falling back to offline mode.', err);
    // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£Ø®ÙŠØ± Ø´Ø¨ÙƒÙŠ ØµØºÙŠØ±
    await new Promise(r=>setTimeout(r, 150));
    return { offline:true };
  }
}

/* --- Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©: Ø²Ø± Sync ÙŠØ­Ø§ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„ÙŠÙˆÙ… */
document.getElementById('syncBtn').addEventListener('click', async ()=>{
  const list = getTodayOrders();
  if(list.length===0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙŠÙˆÙ…');
  let failed = 0;
  for(const o of list){
    const res = await syncOrder(o);
    if(res && res.offline) failed++;
  }
  if(failed===0) alert('âœ” ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©'); else alert(`ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹ Ø£Ùˆ ÙØ´Ù„Øª Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ÙØ´Ù„: ${failed})`);
});

/* --- Init */
function initApp(){
  document.getElementById('loginBtn').addEventListener('click', ()=>{
    const u=document.getElementById('user').value.trim();
    const p=document.getElementById('pass').value;
    if(u==='admin' && p==='1234'){ document.getElementById('loginPage').style.display='none'; document.getElementById('mainPOS').style.display='block'; renderCategories(); renderProducts(); }
    else alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
  });

  document.getElementById('finishBtn').addEventListener('click', finishOrder);
  document.getElementById('printBtn').addEventListener('click', printBill);
  document.getElementById('search').addEventListener('input', renderProducts);
  document.getElementById('barcodeInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ // Ø¯Ø¹Ù… Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯
    const v = e.target.value.trim(); if(!v) return; const prod = products.find(p=> String(p.id)===v || (p.barcode && p.barcode===v)); if(prod) chooseSize(prod.id); else alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬'); e.target.value=''; }});
}

if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', initApp); else initApp();

</script>
</body>
</html>
