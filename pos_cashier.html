<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… ÙƒØ§Ø´ÙŠØ± Ù…Ø­Ù„ÙŠ - Ù…ØªØ¬Ø± Ø³Ø§Ù…Ø­</title>
<style>
  :root{--primary:#2e8ab8;--accent:#2f9d5a;--muted:#6b6b6b;font-family:"Segoe UI",Tahoma,Arial,sans-serif}
  body{margin:0;background:#f6fbfd;color:#023044}
  header{background:linear-gradient(90deg,var(--primary),#3aa0d0);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
  .brand{font-weight:800;font-size:18px}
  .controls{display:flex;gap:8px;align-items:center}
  button{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  button.primary{background:white;color:var(--primary)}
  button.ghost{background:transparent;color:white;border:1px solid rgba(255,255,255,0.12)}
  main{padding:14px}
  .panel{display:flex;gap:12px;align-items:flex-start}
  .card{background:white;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(6,30,40,0.04);flex:1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input[type="number"],input[type="text"]{width:100%;padding:8px;border:1px solid #e2eef6;border-radius:6px;font-size:14px}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border:1px solid #e6f0f6;text-align:center;font-size:14px}
  thead th{background:linear-gradient(180deg,#3aa0d0,#2e8ab8);color:white}
  tfoot td{font-weight:800;background:#f4fff4}
  .small{font-size:12px;color:var(--muted)}
  .right{text-align:right}
  .actions{display:flex;gap:8px;align-items:center}
  .total-card{background:#daf6dc;padding:8px;border-radius:8px;font-weight:800;color:#055b2a}
  .remove-btn{background:#ff6b6b;color:white;border-radius:6px;padding:6px 8px;cursor:pointer}
  @media print{
    header, .controls, .actions, .card .save-area{display:none}
    body{background:white}
    table{font-size:13px}
    th,td{border:1px solid #000}
  }
  /* small responsive */
  @media (max-width:900px){
    .panel{flex-direction:column}
  }
</style>
</head>
<body>

<header>
  <div class="brand">Ø³Ø§Ù…Ø­ - POS (Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ©)</div>
  <div class="controls">
    <div class="small">Ø§Ù„ÙØ§ØªÙˆØ±Ø© #: <span id="invoiceNo"></span></div>
    <div class="small">Ø§Ù„ÙˆÙ‚Øª: <span id="nowLabel"></span></div>
    <button class="primary" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button class="ghost" id="saveCsvBtn">ğŸ’¾ Ø­ÙØ¸ CSV</button>
  </div>
</header>

<main>
  <div class="panel">
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <div class="card" style="max-width:420px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</div>
        <div class="small">Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹ ÙˆØ¥Ø¶Ø§ÙØ©</div>
      </div>

      <label>Ø§Ù„ØµÙ†Ù</label>
      <select id="productSelect"></select>

      <label style="margin-top:8px">Ø§Ù„Ø­Ø¬Ù…</label>
      <select id="sizeSelect"></select>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input type="number" id="qtyInput" min="1" value="1"/>
        </div>
        <div>
          <label>Ø§Ù„Ø³Ø¹Ø± (Ù„Ù„ÙˆØ§Ø­Ø¯)</label>
          <input type="number" id="priceInput" step="0.01" min="0"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="addItemBtn" style="flex:1;background:var(--accent);color:white;border-radius:8px;padding:10px">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙÙ€Ø§ØªÙˆØ±Ø©</button>
        <button id="clearBtn" style="flex:0 0 90px;background:#f0f0f0;border-radius:8px">Ù…Ø³Ø­</button>
      </div>

      <div style="margin-top:12px" class="small">
        ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="card" style="flex:2;min-width:420px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
        <div class="small">ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø£ÙŠ Ø³Ø·Ø± Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø±</div>
      </div>

      <table id="invoiceTable" aria-label="Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
        <thead>
          <tr>
            <th>Øµ</th>
            <th>Ø§Ù„ØµÙ†Ù</th>
            <th>Ø§Ù„Ø­Ø¬Ù…</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="right">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</td>
            <td id="subtotal">0.00</td>
            <td></td>
          </tr>
          <tr>
            <td colspan="5" class="right">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</td>
            <td><input id="taxInput" type="number" value="0" min="0" step="0.1" style="width:100px;padding:6px;border-radius:6px;border:1px solid #e6f0f6"></td>
            <td></td>
          </tr>
          <tr>
            <td colspan="5" class="right">Ø§Ù„Ø®ØµÙ…</td>
            <td><input id="discountInput" type="number" value="0" min="0" step="0.01" style="width:100px;padding:6px;border-radius:6px;border:1px solid #e6f0f6"></td>
            <td></td>
          </tr>
          <tr>
            <td colspan="5" class="right">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</td>
            <td id="grandTotal" class="total-card">0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="small">Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¤Ù‚Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­: <button id="saveLocalBtn" style="margin-left:6px">Ø§Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹</button></div>
        <div class="actions">
          <button id="clearInvoiceBtn" style="background:#ff6b6b;color:white;border-radius:8px;padding:8px 12px">ğŸ—‘ï¸ ØªÙØ±ÙŠØº Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
          <button id="downloadInvoiceBtn" style="background:#2e8ab8;color:white;border-radius:8px;padding:8px 12px">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ (CSV)</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
/* ====== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø¹Ø¯Ù„Ù‡Ø§ ÙƒÙ…Ø§ ØªØ±ÙŠØ¯) ======
  Ø§Ù„Ø´ÙƒÙ„:
  products = {
    "Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„": {sizes: {"ØµØºÙŠØ±":1.5,"ÙˆØ³Ø·":2.5,"ÙƒØ¨ÙŠØ±":3.5}},
    ...
  }
*/
const products = {
  "Ø¹ØµØ§Ø¦Ø±": { sizes: {"ØµØºÙŠØ±":1.50,"ÙˆØ³Ø·":2.50,"ÙƒØ¨ÙŠØ±":3.50} },
  "Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ… ÙØ§Ù†ÙŠÙ„Ø§": { sizes: {"ÙƒÙˆØ¨ ØµØºÙŠØ±":2.00,"ÙƒÙˆØ¨ ÙˆØ³Ø·":3.00,"ÙƒÙˆØ¨ ÙƒØ¨ÙŠØ±":4.50} },
  "Ù…ÙŠØ§Ù‡ Ù…Ø¹Ø¯Ù†ÙŠØ©": { sizes: {"330Ù…Ù„":0.30,"600Ù…Ù„":0.50,"1.5Ù„ØªØ±":1.00} },
  "Ù…ÙˆØ²": { sizes: {"ÙƒÙŠÙ„Ùˆ":0.65} },
  "Ø³Ù†Ø§Ùƒ Ø´ÙŠØ¨Ø³": { sizes: {"Ø¹Ø§Ø¯ÙŠ":0.60,"ÙƒØ¨ÙŠØ±":1.20} }
};

/* ====== Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ====== */
const productSelect = document.getElementById('productSelect');
const sizeSelect = document.getElementById('sizeSelect');
const priceInput = document.getElementById('priceInput');
const qtyInput = document.getElementById('qtyInput');
const addItemBtn = document.getElementById('addItemBtn');
const invoiceTableBody = document.querySelector('#invoiceTable tbody');
const subtotalTd = document.getElementById('subtotal');
const taxInput = document.getElementById('taxInput');
const discountInput = document.getElementById('discountInput');
const grandTotalTd = document.getElementById('grandTotal');
const invoiceNoSpan = document.getElementById('invoiceNo');
const nowLabel = document.getElementById('nowLabel');

/* ====== Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ====== */
let invoice = { items: [] };

/* ====== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ====== */
function initProductList(){
  productSelect.innerHTML = '';
  const emptyOption = document.createElement('option'); emptyOption.textContent='-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --'; emptyOption.value='';
  productSelect.appendChild(emptyOption);
  Object.keys(products).forEach(name=>{
    const opt = document.createElement('option');
    opt.value = name; opt.textContent = name;
    productSelect.appendChild(opt);
  });
}
function populateSizes(productName){
  sizeSelect.innerHTML = '';
  const sizes = products[productName]?.sizes || {};
  Object.keys(sizes).forEach(sz=>{
    const opt = document.createElement('option');
    opt.value = sz; opt.textContent = `${sz} â€” ${Number(sizes[sz]).toFixed(2)}`;
    sizeSelect.appendChild(opt);
  });
  // set price to first size
  const first = Object.keys(sizes)[0];
  if(first) priceInput.value = Number(sizes[first]).toFixed(2);
}

/* ====== Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ù„ÙØ§ØªÙˆØ±Ø© ====== */
function addItem(){
  const prod = productSelect.value;
  if(!prod){ alert('Ø§Ø®ØªØ± ØµÙ†Ù Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const size = sizeSelect.value;
  const qty = parseFloat(qtyInput.value) || 0;
  const price = parseFloat(priceInput.value) || 0;
  if(qty <= 0){ alert('Ø§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©'); return; }
  // push to invoice
  invoice.items.push({ prod, size, qty, price });
  renderInvoice();
  saveToLocalTemp(); // autosave small
}

/* ====== Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ====== */
function renderInvoice(){
  invoiceTableBody.innerHTML = '';
  invoice.items.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    const lineTotal = it.qty * it.price;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td contenteditable="true" data-field="prod">${it.prod}</td>
      <td contenteditable="true" data-field="size">${it.size}</td>
      <td contenteditable="true" data-field="qty">${it.qty}</td>
      <td contenteditable="true" data-field="price">${Number(it.price).toFixed(2)}</td>
      <td data-field="line">${lineTotal.toFixed(2)}</td>
      <td><button class="remove-btn" data-idx="${idx}">Ø­Ø°Ù</button></td>
    `;
    invoiceTableBody.appendChild(tr);
  });
  updateTotals();
}

/* ====== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ====== */
function updateTotals(){
  let subtotal = 0;
  invoice.items.forEach(it=>{
    subtotal += it.qty * it.price;
  });
  const taxPercent = parseFloat(taxInput.value) || 0;
  const discount = parseFloat(discountInput.value) || 0;
  const taxAmount = subtotal * (taxPercent/100);
  const grand = subtotal + taxAmount - discount;
  subtotalTd.textContent = subtotal.toFixed(2);
  grandTotalTd.textContent = grand.toFixed(2);
  // update invoice items display (line totals) in case user edited cells
  [...invoiceTableBody.rows].forEach((r,i)=>{
    r.cells[5].textContent = ( (invoice.items[i].qty*invoice.items[i].price) || 0 ).toFixed(2);
  });
}

/* ====== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« ====== */
productSelect.addEventListener('change', (e)=>{
  populateSizes(e.target.value);
});
sizeSelect.addEventListener('change', ()=>{
  const prod = productSelect.value;
  const sizes = products[prod]?.sizes || {};
  if(sizes[sizeSelect.value] !== undefined) priceInput.value = Number(sizes[sizeSelect.value]).toFixed(2);
});
addItemBtn.addEventListener('click', addItem);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  productSelect.value=''; sizeSelect.innerHTML=''; priceInput.value=''; qtyInput.value=1;
});

/* ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø±ÙŠØ±) */
invoiceTableBody.addEventListener('input', (e)=>{
  const td = e.target.closest('td');
  if(!td) return;
  const row = td.parentElement;
  const idx = Array.from(invoiceTableBody.rows).indexOf(row);
  const field = td.getAttribute('data-field');
  if(!field) return;
  let val = td.textContent.trim();
  if(field==='qty' || field==='price'){
    val = parseFloat(val) || 0;
  }
  invoice.items[idx][field] = val;
  // recompute line total and totals
  row.cells[5].textContent = (invoice.items[idx].qty * invoice.items[idx].price).toFixed(2);
  updateTotals();
  saveToLocalTemp();
});

/* Ø­Ø°Ù Ø³Ø·Ø± */
invoiceTableBody.addEventListener('click', (e)=>{
  if(e.target.matches('.remove-btn')){
    const idx = parseInt(e.target.dataset.idx);
    invoice.items.splice(idx,1);
    renderInvoice();
    saveToLocalTemp();
  }
});

/* ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©/Ø§Ù„Ø®ØµÙ… */
taxInput.addEventListener('input', updateTotals);
discountInput.addEventListener('input', updateTotals);

/* ØªÙ†Ø²ÙŠÙ„ CSV Ù„Ù„ÙØ§ØªÙˆØ±Ø© */
function downloadCSV(){
  if(invoice.items.length===0){ alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©'); return; }
  const shopName = 'Ø³Ø§Ù…Ø­ Ù„Ù„ØªØ¬Ø§Ø±Ø©';
  const now = new Date();
  const headerMeta = [
    ['Ù…Ø­Ù„', shopName],
    ['ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…', invoice.metadata?.no || invoiceNoSpan.textContent],
    ['Ø§Ù„ØªØ§Ø±ÙŠØ®', now.toLocaleString('ar-EG')]
  ];
  // CSV lines
  const rows = [];
  headerMeta.forEach(r => rows.push(r.join(',')));
  rows.push('');
  rows.push(['#','Ø§Ù„ØµÙ†Ù','Ø§Ù„Ø­Ø¬Ù…','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'].join(','));
  invoice.items.forEach((it, i)=>{
    const line = [
      i+1,
      `"${it.prod.replace(/"/g,'""')}"`,
      `"${it.size.replace(/"/g,'""')}"`,
      it.qty,
      Number(it.price).toFixed(2),
      (it.qty*it.price).toFixed(2)
    ];
    rows.push(line.join(','));
  });
  rows.push('');
  rows.push(['','Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ', '', '', '', subtotalTd.textContent].join(','));
  rows.push(['','Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)', '', '', '', taxInput.value].join(','));
  rows.push(['','Ø§Ù„Ø®ØµÙ…', '', '', '', discountInput.value].join(','));
  rows.push(['','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', '', '', '', grandTotalTd.textContent].join(','));

  const csv = rows.join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const filename = `invoice_${invoiceNoSpan.textContent.replace(/\s+/g,'_')}.csv`;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* Ø­ÙØ¸ Ù…Ø¤Ù‚Øª Ù…Ø­Ù„ÙŠ (localStorage) */
function saveToLocalTemp(){
  try{
    const data = { invoice, metadata: { no: invoiceNoSpan.textContent, time: new Date().toISOString() } };
    localStorage.setItem('pos_invoice_temp', JSON.stringify(data));
  }catch(e){}
}
function loadFromLocalTemp(){
  try{
    const raw = localStorage.getItem('pos_invoice_temp');
    if(!raw) return;
    const parsed = JSON.parse(raw);
    invoice = parsed.invoice || {items:[]};
    invoice.metadata = parsed.metadata;
    renderInvoice();
    if(invoice.metadata && invoice.metadata.no) invoiceNoSpan.textContent = invoice.metadata.no;
  }catch(e){}
}
document.getElementById('saveLocalBtn').addEventListener('click', ()=>{
  saveToLocalTemp();
  alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­');
});

/* ØªÙØ±ÙŠØº Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
document.getElementById('clearInvoiceBtn').addEventListener('click', ()=>{
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ')) return;
  invoice.items = [];
  renderInvoice();
  saveToLocalTemp();
});

/* Ø²Ø± ØªÙ†Ø²ÙŠÙ„ CSV */
document.getElementById('downloadInvoiceBtn').addEventListener('click', downloadCSV);

/* Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø±ÙŠØ¹ (header) */
document.getElementById('saveCsvBtn').addEventListener('click', downloadCSV);

/* Ø·Ø¨Ø§Ø¹Ø© - Ù†Ø¬Ù‡Ø² Ø±Ø¤ÙˆØ³ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
document.getElementById('printBtn').addEventListener('click', ()=>{
  if(invoice.items.length===0){ if(!confirm('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ© â€” Ø§Ø·Ø¨Ø¹ØŸ')) return; }
  // Ù†Ø¬Ù‡Ø² HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
  const shopName = 'Ø³Ø§Ù…Ø­ Ù„Ù„ØªØ¬Ø§Ø±Ø©';
  const now = new Date();
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>ÙØ§ØªÙˆØ±Ø© ${invoiceNoSpan.textContent}</title>`;
  html += `<style>body{font-family:Tahoma,Arial;font-size:14px} .center{text-align:center} table{width:100%;border-collapse:collapse} th,td{border:1px solid #000;padding:6px;text-align:center}</style></head><body>`;
  html += `<div class="center"><h2>${shopName}</h2><div>ÙØ§ØªÙˆØ±Ø© #: ${invoiceNoSpan.textContent}</div><div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now.toLocaleString('ar-EG')}</div><hr/></div>`;
  html += `<table><thead><tr><th>Øµ</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø­Ø¬Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody>`;
  invoice.items.forEach((it,i)=>{
    html += `<tr><td>${i+1}</td><td>${it.prod}</td><td>${it.size}</td><td>${it.qty}</td><td>${Number(it.price).toFixed(2)}</td><td>${(it.qty*it.price).toFixed(2)}</td></tr>`;
  });
  html += `</tbody></table>`;
  html += `<div style="margin-top:10px"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong> ${subtotalTd.textContent} &nbsp;&nbsp; <strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©(%):</strong> ${taxInput.value} &nbsp;&nbsp; <strong>Ø§Ù„Ø®ØµÙ…:</strong> ${discountInput.value}</div>`;
  html += `<h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${grandTotalTd.textContent} Ø±ÙŠØ§Ù„</h3>`;
  html += `<div style="margin-top:20px">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§ ğŸ’š</div></body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(()=>w.print(), 300);
});

/* Ù…ÙˆÙ„Ø¯ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø¨Ø³ÙŠØ· */
function genInvoiceNo(){
  const d = new Date();
  const y = d.getFullYear().toString().slice(-2);
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  return `INV${y}${mm}${dd}-${hh}${min}-${Math.floor(Math.random()*900+100)}`;
}

/* ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© */
function init(){
  invoice.metadata = invoice.metadata || {};
  invoiceNoSpan.textContent = invoice.metadata.no || genInvoiceNo();
  nowLabel.textContent = new Date().toLocaleString('ar-EG');
  initProductList();
  loadFromLocalTemp();
  // auto-populate sizes if product selected
  productSelect.addEventListener('change', ()=>populateSizes(productSelect.value));
  // set initial product to first available
  const firstProd = Object.keys(products)[0];
  if(firstProd){ productSelect.value = firstProd; populateSizes(firstProd); }
  // connect add on Enter key for qty/price fields
  [qtyInput, priceInput].forEach(inp=>{
    inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addItem(); }});
  });
  renderInvoice();
}
init();

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€Ù€Ù€ "now" ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© */
setInterval(()=>{ nowLabel.textContent = new Date().toLocaleString('ar-EG'); }, 60000);

</script>

</body>
</html>
